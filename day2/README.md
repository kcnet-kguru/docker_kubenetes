# 도커 스웜

## 도커 스웜을 사용하는 이유
* 운영 환경에 도커를 적용하였을 경우 하나의 호스트 머신에서 도커 엔진을 구동할 경우 리소스 자원이 부족할 경우 서버의 스펙을 높여야 한다.
* 서버 스펙을 높이는 것은 가성비가 좋지 못하므로 여러 대의 서버를 클러스터로 만들어 자원을 병렬로 확장한다.
* 여러대의 서버를 자원으로 사용할 경우 다음과 같은 사항을 고려해야 한다.
    * 새로운 서버나 컨테이너에 대한 발견(Service Discovery)
    * 새로운 컨테이너를 할당할 서버를 선택(Resource Schedule)와 로드밸런서
    * 클러스터 내 서버가 다운됐을 때 고가용성(High Availability) 보장
* 이런한 문제를 해결 방안 중 하나가 도커 스웜 모드

## 도커 스웜 모드
* 도커 스웜모드를 활용하여, 다양한 전략을 세워 컨테이너를 특정 도커 서버에 할당할 수 있고 유동적으로 서버를 확장할 수도 있다.
* PaaS와 같은 용도로 도커 서버 클러스터링을 고려한다면, 가장 먼저 스웜모드를 사용해 보는 것을 권장
* 도커 버전 1.12 이후부터 사용할 수 있는 도커 스웜모드(Swarm Mode)를 사용하는 것을 권장
* 스웜모드는 마이크로 서비스 아키텍처 컨테이너를 다루기 위한 클러스터링 기능에 초점을 맞추고 있다.
* 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 지원

> 서버 클러스터링을 할 때는 반드시 각서버의 NTP 등을 툴을 이용해 동기화 해야 한다. 서버간에 설정된 시간이 다를 경우 예상치 못한 오류가 발생할 수 있다.

> 도커 스웜 매니저는 기본적으로 2377번 포트를 사용하며, 노드 사이의 통신에 7946/tcp, 7946/udp 포트를, 스웜이 사용하는 네트워크인 ingress 오버레이 네트워크에 4789/tcp, 4789/udp를 사용한다.

* 도커 스웜 매니저 중 리더 매니저는 모든 매니저 노드에 대한 데이터 동기와와 관리를 담당하므로 항상 작동할 수 있는 상태여야 한다.
* 리더 매니저 서버가 다운되는 등의 장애가 생기면 매니저는 새로운 리더를 선출한다(Raft Consensus 알고리즘)


## 스웜 모드 서비스
* 서비스는 같은 이미지에서 생성된 컨테이너의 집합이며, 서비스를 제어하면 해당 서비스 내의 컨테이너에 같은 명령이 수행
* 서비스 내에 컨테이너는 1개 이상 존재할 수 있으며, 컨테이너들은 각 워커 노드와 매니저 노드에 할당 된다.
* 이러한 컨테이너를 태스크(Task)라고 한다.
* 서비스는 롤링 업데이트(Rolling Update) 기능도 제공한다.
* 서비스의 모드는 두가지가 있는데 하나는 위에서 생성한 Nginx 웹 서버 서비스와 같이 레플리카셋의 수를 정의해 그만큼의 같은 컨테이너를 생성하는 복제모드와 글로벌 모드 이다.
* 스웜 모드는 여러 개의  도커 엔진에 같은 컨테이너를 분산해서 할당하기 떄문에 각 도커 데몬의 네트워크가 하나로 묶인 네트워크 풀이 필요하다.
* 서비스를 외부로 노출했을 때 어느 노드로 접근하더라도 해당 서비스의 컨테이너에 접근할 수 있게 라우팅 기능이 필요한다.

### ingress 네트워크
* ingress 네트워크는 스웜 클러스터를 생성하면 자동으로 등록되는 네트워크로서, 스웜 모드를 사용할 때만 유효하다.
* 스웤 클러스터에 등록된 노드라면 전부 ingress 네트워크가 생성된다.
* ingress 네트워크는 어떤 스웜 노드에 접근하더라도 서비스내의 컨테이너에 접근할 수 있게 설정하는 라우터 메시를 구성하고, 서비스 내의 컨테이너에 대한 접근을 라운드 로빈 방식으로 분산하는 로드 밸런싱을 담당한다.
* ingress 네트워크는 오버레이 네트워크 드라이버를 사용한다. 오버레이 네트워크는 여러개의 도커 데몬을 하나의 네트워크 풀로 만드는 네트워크 가상화 기술 중 하나이다.
* 도커에 오버레이 네트워크를 적용하면 여러 도커 데몬에 존재하는 컨테이너가 서로 통신할 수 있다.


### 스웜 모드에서의 볼륨
* 스웜 클러스터에서 볼륨을 사용하기란 상당히 까다롭다. 서비스를 할당받을 수 있는 모든 노드가 볼륨 데이터를 가지고 있어야 하기 때문이다.
* 볼륨을 적용하는 일반적인 방법은 어느 노드에서도 접근 가능한 퍼시스턴트 스토리지(Persitent Storage)를 사용하는 것. 퍼시스턴트 스토리지는 호스트와 컨테이와 별개로 외부에 존재해 네트워크로 마운트할 수 있는 스토리지이다.
